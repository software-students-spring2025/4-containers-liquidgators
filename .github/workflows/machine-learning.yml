name: machine-learning-yaml
on: [pull_request]

jobs:
    test:
        runs-on: ubuntu-latest
        strategy:
            matrix: 
                python-version: ["3.12.3"]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
                
            - name: Install Python, pipenv and Pipfile packages
              uses: kojoru/prepare-pipenv@v1
              with:
                python-version: ${{ matrix.python-version }}

            - name: Write secret to file
              run: |
                echo '${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}' > machine-learning-client/credentials.json

            - name: Set environment variable
              run: |
                echo "GOOGLE_APPLICATION_CREDENTIALS=$PWD/machine-learning-client/credentials.json" >> $GITHUB_ENV
                        
            - name: Run Pytest
              working-directory: machine-learning-client
              env:
                GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}
              run: |
                pipenv install pytest pytest-cov
                pipenv --venv
                pipenv run python -m pytest --cov=speech_and_text.py --cov-report=term-missing